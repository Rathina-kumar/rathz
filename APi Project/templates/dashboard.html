{% extends 'base.html' %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<div class="container py-4">
  <!-- Welcome and Filter Section -->
  <div class="row justify-content-between align-items-center mb-3">
    <div class="col-md-6 text-start">
      <h5>üëã Welcome, {{ user }}</h5>
    </div>
    <div class="col-md-6 text-end">
      <form method="get" action="/dashboard" class="d-flex justify-content-end gap-2">
        <select name="filter_month" class="form-select w-auto">
          {% for month in range(1, 13) %}
            <option value="{{ month }}" {% if month == selected_month %}selected{% endif %}>
              {{ ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][month - 1] }}
            </option>
          {% endfor %}
        </select>
        <select name="filter_year" class="form-select w-auto">
          {% for year in range(2020, 2031) %}
            <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
          {% endfor %}
        </select>
        <button type="submit" class="btn btn-outline-primary">üîÑ Filter</button>
      </form>
    </div>
  </div>

  <!-- Budget Summary -->
  <div class="row text-center mb-4">
    <div class="col-md-4">
      <div class="card text-white bg-primary shadow">
        <div class="card-body">
          <h5 class="card-title">Budget</h5>
          <p class="card-text fs-4">‚Çπ {{ budget }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-white" style="background-color:#d68c45">
        <div class="card-body">
          <h5 class="card-title">Spent Money</h5>
          <p class="card-text fs-4">‚Çπ {{ total_spent }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-white bg-success shadow">
        <div class="card-body">
          <h5 class="card-title">Remaining Money</h5>
          <p class="card-text fs-4">‚Çπ {{ remaining }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Form -->
  <form method="get" action="/dashboard">
    <input type="hidden" name="filter_month" value="{{ selected_month }}">
    <input type="hidden" name="filter_year" value="{{ selected_year }}">

    <div class="row g-3 mb-4 align-items-end">
      <div class="col-md-2">
        <label class="form-label fw-semibold">Filter Type</label>
        <select id="filter-type" name="filter_type" class="form-select">
          <option value="date" {% if request.query_params.get('filter_type') == "date" %}selected{% endif %}>Date</option>
          <option value="month" {% if request.query_params.get('filter_type') == "month" %}selected{% endif %}>Month</option>
          <option value="year" {% if request.query_params.get('filter_type') == "year" %}selected{% endif %}>Year</option>
        </select>
      </div>

      <div class="col-md-3" id="date-input">
        <label class="form-label fw-semibold">Pick a Date</label>
        <input type="date" name="filter_date" class="form-control"
               value="{{ request.query_params.get('filter_date', '') }}">
      </div>

      <div class="col-md-3 d-none" id="month-input">
        <label class="form-label fw-semibold">Select Month</label>
        <select name="filter_month_form" class="form-select">
          {% for month in range(1, 13) %}
            <option value="{{ month }}" {% if request.query_params.get('filter_month') == month|string %}selected{% endif %}>
              {{ ["January","February","March","April","May","June","July","August","September","October","November","December"][month - 1] }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2 d-none" id="year-input">
        <label class="form-label fw-semibold">Select Year</label>
        <select name="filter_year_form" class="form-select">
          {% for year in range(2020, 2031) %}
            <option value="{{ year }}" {% if request.query_params.get('filter_year') == year|string %}selected{% endif %}>{{ year }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">Category</label>
        <select name="filter_category" class="form-select">
          <option value="">All Categories</option>
          <option value="Food" {% if request.query_params.get('filter_category') == "Food" %}selected{% endif %}>Food</option>
          <option value="Travel" {% if request.query_params.get('filter_category') == "Travel" %}selected{% endif %}>Travel</option>
          <option value="Movies" {% if request.query_params.get('filter_category') == "Movies" %}selected{% endif %}>Movies</option>
        </select>
      </div>

      <div class="col-md-1">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fa fa-search"></i>
        </button>
      </div>
    </div>
  </form>

  <!-- Charts -->
  {% if category_totals %}
    <div class="card mb-4">
      <div class="card-header bg-info text-white">Spending by Category</div>
      <div class="card-body d-flex justify-content-center">
        <div style="width: 290px; height: 290px;">
          <canvas id="expensePieChart" width="290" height="290"></canvas>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Category Wise Breakdown -->
  <div class="card mb-4">
    <div class="card-header bg-secondary text-white">Category Wise Expense Breakdown</div>
    <div class="card-body text-center">
      {% set selected_category = request.query_params.get('filter_category', '') %}
      {% if selected_category and chart_data %}
        <div style="max-width: 500px; margin: 0 auto;">
          <canvas id="categoryBarChart" style="min-width: 300px; height: 300px;"></canvas>
        </div>
      {% elif filter_type == "year" and yearly_category_monthly_totals %}
        <div style="max-width: 700px; margin: 0 auto;">
          <canvas id="yearCategoryMonthlyChart" style="min-width: 400px; height: 300px;"></canvas>
        </div>
      {% else %}
        <p class="text-muted mt-3">üôÅ No breakdown available. Please choose a category or select year filter.</p>
      {% endif %}
    </div>
  </div>

  <!-- Monthly or Date Breakdown -->
  <div class="card mb-4">
    <div class="card-header bg-dark text-white">
      {% if filter_type == "year" %}
        Yearly Expense Breakdown
      {% elif filter_type == "month" %}
        Monthly Expense Breakdown
      {% else %}
        Date-wise Expense Breakdown
      {% endif %}
    </div>
    <div class="card-body text-center">
      {% if (filter_type == "month" or filter_type == "year") and monthly_totals %}
        <div style="max-width: 600px; margin: 0 auto;">
          <canvas id="monthlyExpenseChart" style="min-width: 300px; height: 300px;"></canvas>
        </div>
      {% elif filter_type == "date" and filter_date %}
        <div class="progress w-75 mx-auto">
          {% set percent = (date_total / budget * 100) if budget else 0 %}
          <div class="progress-bar bg-warning" role="progressbar"
               style="width: {{ percent if percent <= 100 else 100 }}%;"
               aria-valuenow="{{ percent }}" aria-valuemax="100"></div>
        </div>
        <p class="mt-2">{{ filter_date }} - ‚Çπ{{ date_total }} spent</p>

        {% if date_category_totals %}
          <div style="max-width: 500px; margin: 20px auto;">
            <canvas id="dateCategoryChart" style="min-width: 300px; height: 300px;"></canvas>
          </div>
        {% else %}
          <p class="text-muted mt-2">No expenses for {{ filter_date }} to show category breakdown.</p>
        {% endif %}
      {% else %}
        <p class="text-muted">No data available for selected filters.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Chart Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const typeSelect = document.getElementById('filter-type');
  const dateInput = document.getElementById('date-input');
  const monthInput = document.getElementById('month-input');
  const yearInput = document.getElementById('year-input');

  function toggleInputs() {
    dateInput.classList.add('d-none');
    monthInput.classList.add('d-none');
    yearInput.classList.add('d-none');
    const value = typeSelect.value;
    if (value === 'date') dateInput.classList.remove('d-none');
    if (value === 'month') {
      monthInput.classList.remove('d-none');
      yearInput.classList.remove('d-none');
    }
    if (value === 'year') yearInput.classList.remove('d-none');
  }

  typeSelect.addEventListener('change', toggleInputs);
  window.onload = toggleInputs;
</script>

<script>
  const categoryTotals = {{ category_totals | tojson }};
  const labels = Object.keys(categoryTotals);
  const data = Object.values(categoryTotals);

  if (labels.length > 0) {
    new Chart(document.getElementById('expensePieChart'), {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{ data: data, backgroundColor: ['#28a745', '#ff69b4', '#dc3545'] }]
      }
    });
  }

  {% if selected_category and chart_data %}
  new Chart(document.getElementById('categoryBarChart'), {
    type: 'bar',
    data: {
      labels: {{ chart_labels | tojson }},
      datasets: [{ label: '{{ selected_category }}', data: {{ chart_data | tojson }}, backgroundColor: '#36a2eb' }]
    },
    options: { scales: { y: { beginAtZero: true } } }
  });
  {% endif %}

  {% if filter_type == "year" and yearly_category_monthly_totals %}
    const rawData = {{ yearly_category_monthly_totals | tojson }};
    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    const categoriesSet = new Set();
    for (const month of monthNames) {
      for (const cat in rawData[month]) {
        categoriesSet.add(cat);
      }
    }

    const allCategories = Array.from(categoriesSet);
    const colorMap = {
      "Food": "#4caf50",
      "Travel": "#e91e63",
      "Movies": "#f44336"
    };

    const datasets = allCategories.map(cat => ({
      label: cat,
      data: monthNames.map(m => rawData[m]?.[cat] || 0),
      backgroundColor: colorMap[cat] || '#999'
    }));

    new Chart(document.getElementById("yearCategoryMonthlyChart"), {
      type: 'bar',
      data: {
        labels: monthNames,
        datasets: datasets
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });
  {% endif %}

 {% if (filter_type == "month" or filter_type == "year") and monthly_totals %}
  const monthlyLabels = Object.keys({{ monthly_totals | tojson }});
  const monthlyValues = Object.values({{ monthly_totals | tojson }});

  new Chart(document.getElementById('monthlyExpenseChart'), {
    type: 'bar',
    data: {
      labels: monthlyLabels,
      datasets: [{ label: '{{ "Category" if filter_type == "month" else "Monthly" }} Expense (‚Çπ)', data: monthlyValues, backgroundColor: '#f39c12' }]
    },
    options: { scales: { y: { beginAtZero: true } } }
  });
  {% endif %} 

  {% if filter_type == "date" and date_category_totals %}
  new Chart(document.getElementById('dateCategoryChart'), {
    type: 'bar',
    data: {
      labels: {{ date_category_totals.keys() | list | tojson }},
      datasets: [{ label: 'Expenses on {{ filter_date }}', data: {{ date_category_totals.values() | list | tojson }}, backgroundColor: '#ffa726' }]
    },
    options: { scales: { y: { beginAtZero: true } } }
  });
  {% endif %}
</script>
{% endblock %}
